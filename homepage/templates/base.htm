## this is the skeleton of all pages on in this app - it defines the basic html tags

## set up a StaticRenderer object to enable the CSS/JS automatic inclusion magic.
<%! from django_mako_plus.controller import static_files %>
<%  static_renderer = static_files.StaticRenderer(self) %>

<%! from datetime import datetime %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Candor Contracts strives to provide the easiest way to buy and sell apartment contracts, making a student's life much less hectic.">
    <meta name="keywords" content="Candor, Candor Contracts, contract, contracts, apartment, apartment contracts, student, students">
    <meta name="author" content="Daniel Wyatt">
    <meta name="google-signin-client_id" content="267671914850-gtsdijk1ela2bc5076t6alla50m2t2ad.apps.googleusercontent.com">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    
    <%block name="title">
        <title>Candor Contracts - Homepage</title>
    </%block>

    <link type="image/png" rel="icon" href="${ STATIC_URL }homepage/media/logo.png">
    
    ## add any site-wide scripts or CSS here; for example, jquery:
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="${ STATIC_URL }homepage/scripts/jquery.form.js"></script>
    <script src="https://apis.google.com/js/api:client.js"></script>
    <script type="text/javascript" src="${ STATIC_URL }homepage/scripts/jquery.tooltipster.min.js"></script>
    <script src="${ STATIC_URL }homepage/scripts/jquery.viewport.min.js" type="text/javascript"></script>
    <script src="${ STATIC_URL }homepage/scripts/parallax.min.js"></script>
    <!-- <script src="${ STATIC_URL }homepage/scripts/select2.min.js"></script> -->

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    ## <link rel="stylesheet" type="text/css" href="${ STATIC_URL }homepage/styles/tooltipster.css" />
    <link type="text/css" rel="stylesheet" href="${ STATIC_URL }homepage/styles/font-awesome.css" />
    ## <link href="${ STATIC_URL }homepage/styles/select2.min.css" rel="stylesheet" />

    ## render the css with the same name as this page
    ${ static_renderer.get_template_css(request, context)  }


</head>
<body cz-shortcut-listen="true" id="home">
    <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '1639785522934996',
                xfbml      : true,
                version    : 'v2.8'
            });
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>

    <script>
        // start Google login
        function onSignIn(googleUser, element) {
            $(element).append('<i class="fa fa-spinner fa-fw fa-spin"></i>');
            var profile = googleUser.getBasicProfile();
            var scopes = googleUser.getGrantedScopes();
            // console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
            // console.log('Name: ' + profile.getName());
            // console.log('Image URL: ' + profile.getImageUrl());
            // console.log('Email: ' + profile.getEmail());
            // $('.sign-in').text('Welcome, ' + profile.getName());
            // $('#login-slide .close').trigger('click');

            var set = true;
            var csrf = $('[name="csrfmiddlewaretoken"]').val();
            var name = profile.getName();
            var image = profile.getImageUrl();
            var email = profile.getEmail();
            var id_token = googleUser.getAuthResponse().id_token;
            var method = 'google';

            setLogin(set, csrf, name, image, email, id_token, method);
        }

        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
                $.ajax({
                    type: 'POST',
                    url: '/homepage/',
                    data: {set: false, csrfmiddlewaretoken: $('[name="csrfmiddlewaretoken"]').val()},
                    success: function(ret) {
                        if (ret == 'True') {
                            window.location = '/homepage/';
                        }
                    },
                    error: function(e) {
                        console.log(e);
                    }
                });
            });
        }

        var googleUser = {};
        var startApp = function() {
            gapi.load('auth2', function() {
                // Retrieve the singleton for the GoogleAuth library and set up the client.
                auth2 = gapi.auth2.init({
                    client_id: '267671914850-gtsdijk1ela2bc5076t6alla50m2t2ad.apps.googleusercontent.com',
                    cookiepolicy: 'single_host_origin',
                    // Request scopes in addition to 'profile' and 'email'
                    scope: 'profile email https://www.googleapis.com/auth/plus.me https://www.googleapis.com/auth/plus.login'
                });
                attachSignin(document.getElementById('my-signin2'));
            })
        }

        function attachSignin(element) {
            // console.log(element.id);
            auth2.attachClickHandler(element, {},
                function(googleUser) {
                    onSignIn(googleUser, element);
                },
                function(error) {
                    // alert(JSON.stringify(error, undefined, 2));
                }
            );
        }

        startApp();
        // end Google login

        // start Facebook login

        // Now that we've initialized the JavaScript SDK, we call 
        // FB.getLoginStatus().  This function gets the state of the
        // person visiting this page and can return one of three states to
        // the callback you provide.  They can be:
        //
        // 1. Logged into your app ('connected')
        // 2. Logged into Facebook, but not your app ('not_authorized')
        // 3. Not logged into Facebook and can't tell if they are logged into
        //    your app or not.
        //
        // These three cases are handled in the callback function.

        // This is called with the results from from FB.getLoginStatus().
          function statusChangeCallback(response) {
            console.log('statusChangeCallback');
            console.log(response);
            // The response object is returned with a status field that lets the
            // app know the current login status of the person.
            // Full docs on the response object can be found in the documentation
            // for FB.getLoginStatus().
            if (response.status === 'connected') {
              // Logged into your app and Facebook.
            } else if (response.status === 'not_authorized') {
              // The person is logged into Facebook, but not your app.
              facebookLogin();
            } else {
              // The person is not logged into Facebook, so we're not sure if
              // they are logged into this app or not.
              facebookLogin();
            }
          }

          // This function is called when someone finishes with the Login
          // Button.  See the onlogin handler attached to it in the sample
          // code below.
          function checkLoginState() {
            FB.getLoginStatus(function(response) {
              statusChangeCallback(response);
            });
          }

          function facebookLogin() {
            FB.login(function(response) {
                if (response.authResponse) {
                 console.log('Welcome!  Fetching your information.... ');
                 FB.api('/me', {fields: ['first_name', 'last_name', 'name', 'email', 'picture']}, function(response) {
                   var set = true;
                   var csrf = $('[name="csrfmiddlewaretoken"]').val();
                   var name = response.name;
                   var image = response.picture.data.url;
                   var email = response.email;
                   var id_token = response.id;
                   var method = 'facebook';
   
                   setLogin(set, csrf, name, image, email, id_token, method);
                 });
                } else {
                 console.log('User cancelled login or did not fully authorize.');
                 $('.btn-facebook .fa-spinner').remove();
                }
            }, {scope: 'email,public_profile,user_friends'});
          };
        // end Facebook login

          function facebookLogout() {
            FB.getLoginStatus(function(response) {
                console.log(response);
                if (response.authResponse) {
                    FB.logout(function(response) {
                        // user is now logged out
                        $.ajax({
                            type: 'POST',
                            url: '/homepage/',
                            data: {set: false, csrfmiddlewaretoken: $('[name="csrfmiddlewaretoken"]').val()},
                            success: function(ret) {
                                if (ret == 'True') {
                                    window.location = '/homepage/';
                                }
                            },
                            error: function(e) {
                                console.log(e);
                            }
                        });
                    });
                }
                else {
                    $.ajax({
                        type: 'POST',
                        url: '/homepage/',
                        data: {set: false, csrfmiddlewaretoken: $('[name="csrfmiddlewaretoken"]').val()},
                        success: function(ret) {
                            if (ret == 'True') {
                                window.location = '/homepage/';
                            }
                        },
                        error: function(e) {
                            console.log(e);
                        }
                    });
                }
            });
          };

          function signOutAll(method) {
            if (method == 'google') {
                signOut();
            }
            else if (method == 'facebook') {
                facebookLogout();
            }
          }

          function setLogin(set, csrfmiddlewaretoken, name, image, email, id_token, method) {
            $.ajax({
                type: 'POST',
                url: '/homepage/',
                data: {set: set, csrfmiddlewaretoken: csrfmiddlewaretoken, name: name, image: image, email: email, id_token: id_token, method: method},
                success: function(ret) {
                    if (ret == 'True') {
                        window.location = '/sell/post/';
                    }
                },
                error: function(e) {
                    console.log(e);
                }
            });
          };
    </script>

    <%block name="navigation">
        ## <div class="navbar-margin">
            %if request.session['active'] == 'home':
                <nav class="navbar navbar-default navbar-fixed-top hide">
            %else:
                <nav class="navbar navbar-default navbar-fixed-top">
            %endif
                <div class="container">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/"><img src="${ STATIC_URL }homepage/media/candor.png" />
                            <span class="brand-text">
                                % if environment != '/var/www/candor':
                                    Candor Contracts Dev
                                % else:
                                    Candor Contracts
                                % endif
                            </span>
                        </a>
                    </div>

                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <!-- <li><a href="#">Link <span class="sr-only">(current)</span></a></li>
                            <li><a href="#">Link</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="#">Action</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">Separated link</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">One more separated link</a></li>
                                </ul>
                            </li> -->
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <!-- <li><a href="#">Link</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="#">Action</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">Separated link</a></li>
                                </ul>
                            </li> -->
                            <%block name="rightlinks">
                                <li><a href="/">Home</a></li>
                                <li><a href="/#about">About</a></li>
                                <li><a href="/#contact">Contact</a></li>
                                <li><a href="/privacy/">Privacy</a></li>
                            </%block>
                            %if 'user' not in request.session:
                                <li><a href="#" class="sign-in">Sign In</a></li>
                            %else:
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span class="name">Hello, ${ request.session['user']['name'][0] }</span><span class="account">Your Account</span> <span class="caret"></span></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <div class="dropdown-image-container">
                                            <div class="user-image" style="background-image:url('${request.session['user']['image']}');"></div>
                                            <div class="user-tag">${ request.session['user']['name'][0][:1] } ${ request.session['user']['name'][1][:1] }</div>
                                        </div>
                                        <li class="divider"></li>
                                        ## <li><a href="/dashboard/"><i class="fa fa-dashboard fa-fw"></i>Dashboard</a></li>
                                        ## <li class="divider"></li>
                                        <li><a href="/accounts/"><i class="fa fa-user fa-fw"></i>Account</a></li>
                                        <li class="divider"></li>
                                        <li><a href="#" onclick="signOutAll( '${ request.session['user']['method'] }' )"><i class="fa fa-sign-out fa-fw"></i>Logout</a></li>
                                    </ul>
                                </li>
                            %endif
                            ## <li><div class="fb-login-button" data-max-rows="1" data-size="large" data-show-faces="false" data-auto-logout-link="false"></div></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div><!-- /.container-fluid -->
            </nav>
        ## </div>
    </%block>

    <%block name="content">
        Site content goes here in sub-templates.
    </%block>  

    <%block name="footer">
        <footer>
            Copyright &copy; ${ datetime.now().year } Candor Contracts
        </footer>
    </%block>

    <%block name="login">
        <form id="set-user" style="display: none;">
            <input type="submit" />
            <input type='hidden' name='csrfmiddlewaretoken' value='${ csrf_token }' />
        </form>
    </%block>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-70886333-1', 'auto');
        ga('send', 'pageview');

    </script>
    
    ## render the JS with the same name as this page
    ${ static_renderer.get_template_js(request, context)  }


</body>
</html>